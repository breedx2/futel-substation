---
- name: load secrets
  include_vars: "deploy/backup_secrets.yml"
  no_log: true
- name: copy ssh private key
  template:
    src: src/etc/ssh/backup_id_rsa.j2
    dest: "{{ basedir }}/futel/etc/ssh/backup_id_rsa"
- name: update ssh private key perms
  file:
    path: "{{ basedir }}/futel/etc/ssh/backup_id_rsa"
    mode: "go-r"
- name: copy backup src
  copy:
    src: src/bin
    dest: "{{ basedir }}/futel"
- name: make backup scripts executable
  file:
    path: "{{ item }}"
    mode: "u+x"
  with_items:
    - "{{ basedir }}/futel/bin/backup_mechaoperator.sh"
    - "{{ basedir }}/futel/bin/stats-futel-prod.sh"
    - "{{ basedir }}/futel/bin/write_stats.py"
    - "{{ basedir }}/futel/bin/create_stats_table.py"    
- name: set up sqlite schema
  command: "{{ basedir }}/futel/bin/create_stats_table.py {{ basedir }}/futel/var/spool/stats/prod/metrics.db"
  args:
    creates: "{{ basedir }}/futel/var/spool/stats/prod/metrics.db"
- name: create cron job
  cron:
    name: "prod backup"
    minute: "*/5"
    job: "{{ basedir }}/futel/bin/backup_mechaoperator.sh"
